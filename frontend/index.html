<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MitmProxy Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shield-check"></i>
                MitmProxy Manager
            </a>
            <div class="navbar-nav ms-auto">
                <button class="btn btn-outline-light me-2" onclick="exportConfig()">
                    <i class="bi bi-download"></i> 导出配置
                </button>
                <button class="btn btn-outline-light" onclick="document.getElementById('importFile').click()">
                    <i class="bi bi-upload"></i> 导入配置
                </button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importConfig(this)">
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <!-- 代理状态面板 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-router"></i>
                            代理服务状态
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <span class="status-indicator me-2" id="statusIndicator"></span>
                                    <span id="statusText">检查中...</span>
                                </div>
                                <div id="proxyInfo" class="mt-2" style="display: none;">
                                    <small class="text-muted">
                                        代理地址: <span id="proxyAddress"></span>
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-success me-2" id="startBtn" onclick="startProxy()">
                                    <i class="bi bi-play-fill"></i> 启动代理
                                </button>
                                <button class="btn btn-danger" id="stopBtn" onclick="stopProxy()">
                                    <i class="bi bi-stop-fill"></i> 停止代理
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 标签页导航 -->
        <div class="row mb-3">
            <div class="col-12">
                <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="api-tab" data-bs-toggle="tab" data-bs-target="#api-pane" type="button" role="tab">
                            <i class="bi bi-list-ul"></i> API配置管理
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="download-tab" data-bs-toggle="tab" data-bs-target="#download-pane" type="button" role="tab">
                            <i class="bi bi-download"></i> 文件下载拦截
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="mapping-tab" data-bs-toggle="tab" data-bs-target="#mapping-pane" type="button" role="tab">
                            <i class="bi bi-arrow-left-right"></i> 请求映射管理
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- 标签页内容 -->
        <div class="tab-content" id="mainTabContent">
            <!-- API管理标签页 -->
            <div class="tab-pane fade show active" id="api-pane" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-list-ul"></i>
                                    API配置管理
                                </h5>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-primary me-2" onclick="showAddApiModal()">
                                <i class="bi bi-plus-lg"></i> 添加API
                            </button>
                            <button class="btn btn-outline-secondary me-2" onclick="batchEnable()">
                                <i class="bi bi-check-all"></i> 批量启用
                            </button>
                            <button class="btn btn-outline-secondary" onclick="batchDisable()">
                                <i class="bi bi-x-lg"></i> 批量禁用
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 搜索过滤 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="searchInput" placeholder="搜索API名称或URL..." onkeyup="filterAPIs()">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="methodFilter" onchange="filterAPIs()">
                                    <option value="">所有方法</option>
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                    <option value="PATCH">PATCH</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="statusFilter" onchange="filterAPIs()">
                                    <option value="">所有状态</option>
                                    <option value="enabled">已启用</option>
                                    <option value="disabled">已禁用</option>
                                </select>
                            </div>
                        </div>

                        <!-- API列表 -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th width="40">
                                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                        </th>
                                        <th>名称</th>
                                        <th>方法</th>
                                        <th>URL</th>
                                        <th>状态</th>
                                        <th>状态码</th>
                                        <th width="200">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="apiTableBody">
                                    <!-- API列表将通过JavaScript动态生成 -->
                                </tbody>
                            </table>
                        </div>

                        <!-- 空状态 -->
                        <div id="emptyState" class="text-center py-5" style="display: none;">
                            <i class="bi bi-inbox display-1 text-muted"></i>
                            <h5 class="text-muted mt-3">暂无API配置</h5>
                            <p class="text-muted">点击"添加API"按钮创建第一个API配置</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 文件下载拦截标签页 -->
            <div class="tab-pane fade" id="download-pane" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-download"></i>
                                    文件下载拦截配置
                                </h5>
                                <div>
                                    <button class="btn btn-primary me-2" onclick="showAddDownloadModal()">
                                        <i class="bi bi-plus-lg"></i> 添加拦截规则
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- 搜索过滤 -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="downloadSearchInput" placeholder="搜索规则名称或URL模式..." onkeyup="filterDownloads()">
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="downloadStatusFilter" onchange="filterDownloads()">
                                            <option value="">所有状态</option>
                                            <option value="enabled">已启用</option>
                                            <option value="disabled">已禁用</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- 文件下载拦截列表 -->
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>名称</th>
                                                <th>URL模式</th>
                                                <th>本地文件路径</th>
                                                <th>内容类型</th>
                                                <th>状态</th>
                                                <th width="150">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="downloadTableBody">
                                            <!-- 文件下载列表将通过JavaScript动态生成 -->
                                        </tbody>
                                    </table>
                                </div>

                                <!-- 空状态 -->
                                <div id="downloadEmptyState" class="text-center py-5" style="display: none;">
                                    <i class="bi bi-folder-x display-1 text-muted"></i>
                                    <h5 class="text-muted mt-3">暂无文件下载拦截配置</h5>
                                    <p class="text-muted">点击"添加拦截规则"按钮创建第一个下载拦截配置</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 请求映射管理标签页 -->
            <div class="tab-pane fade" id="mapping-pane" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-arrow-left-right"></i>
                                    请求映射管理
                                </h5>
                                <div>
                                    <button class="btn btn-primary me-2" onclick="showAddMappingModal()">
                                        <i class="bi bi-plus-lg"></i> 添加映射规则
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- 搜索过滤 -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="mappingSearchInput" placeholder="搜索规则名称或URL模式..." onkeyup="filterMappings()">
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="mappingStatusFilter" onchange="filterMappings()">
                                            <option value="">所有状态</option>
                                            <option value="enabled">已启用</option>
                                            <option value="disabled">已禁用</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- 请求映射列表 -->
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>名称</th>
                                                <th>URL模式</th>
                                                <th>目标地址</th>
                                                <th>支持方法</th>
                                                <th>状态</th>
                                                <th width="150">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="mappingTableBody">
                                            <!-- 请求映射列表将通过JavaScript动态生成 -->
                                        </tbody>
                                    </table>
                                </div>

                                <!-- 空状态 -->
                                <div id="mappingEmptyState" class="text-center py-5" style="display: none;">
                                    <i class="bi bi-arrow-left-right display-1 text-muted"></i>
                                    <h5 class="text-muted mt-3">暂无请求映射配置</h5>
                                    <p class="text-muted">点击"添加映射规则"按钮创建第一个请求映射配置</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑API模态框 -->
    <div class="modal fade" id="apiModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="apiModalTitle">添加API</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="apiForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="apiName" class="form-label">API名称 *</label>
                                    <input type="text" class="form-control" id="apiName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="apiMethod" class="form-label">HTTP方法 *</label>
                                    <select class="form-select" id="apiMethod" required>
                                        <option value="GET">GET</option>
                                        <option value="POST">POST</option>
                                        <option value="PUT">PUT</option>
                                        <option value="DELETE">DELETE</option>
                                        <option value="PATCH">PATCH</option>
                                        <option value="HEAD">HEAD</option>
                                        <option value="OPTIONS">OPTIONS</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="apiUrl" class="form-label">API URL *</label>
                            <input type="text" class="form-control" id="apiUrl" placeholder="/api/example" required>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="responseStatus" class="form-label">响应状态码</label>
                                    <input type="number" class="form-control" id="responseStatus" value="200" min="100" max="599">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="contentType" class="form-label">Content-Type</label>
                                    <select class="form-select" id="contentType">
                                        <option value="application/json">application/json</option>
                                        <option value="text/plain">text/plain</option>
                                        <option value="text/html">text/html</option>
                                        <option value="application/xml">application/xml</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="responseHeaders" class="form-label">响应头 (JSON格式)</label>
                            <textarea class="form-control" id="responseHeaders" rows="3" placeholder='{"Content-Type": "application/json"}'></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="responseBody" class="form-label">响应体 (JSON格式)</label>
                            <textarea class="form-control" id="responseBody" rows="8" placeholder='{"errno": 0, "error": "", "data": {}}'></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveAPI()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑文件下载拦截模态框 -->
    <div class="modal fade" id="downloadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="downloadModalTitle">添加文件下载拦截</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="downloadForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="downloadName" class="form-label">规则名称 *</label>
                                    <input type="text" class="form-control" id="downloadName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="downloadContentType" class="form-label">内容类型</label>
                                    <select class="form-select" id="downloadContentType">
                                        <option value="">自动检测</option>
                                        <option value="application/pdf">PDF文档</option>
                                        <option value="text/plain">纯文本</option>
                                        <option value="application/json">JSON文件</option>
                                        <option value="application/zip">ZIP压缩包</option>
                                        <option value="image/jpeg">JPEG图片</option>
                                        <option value="image/png">PNG图片</option>
                                        <option value="application/octet-stream">二进制文件</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="downloadUrlPattern" class="form-label">URL匹配模式 *</label>
                            <input type="text" class="form-control" id="downloadUrlPattern" placeholder="例如: .*\.pdf$ 或 https://example.com/files/.*" required>
                            <div class="form-text">支持正则表达式。例如：<code>.*\.pdf$</code> 匹配所有PDF文件</div>
                        </div>

                        <div class="mb-3">
                            <label for="downloadFilePath" class="form-label">本地文件路径 *</label>
                            <input type="text" class="form-control" id="downloadFilePath" placeholder="/path/to/local/file.pdf" required>
                            <div class="form-text">请提供服务器上本地文件的完整路径</div>
                        </div>

                        <div class="mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">常用匹配模式示例</h6>
                                </div>
                                <div class="card-body">
                                    <small class="text-muted">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <strong>文件扩展名匹配：</strong><br>
                                                <code>.*\.pdf$</code> - 所有PDF文件<br>
                                                <code>.*\.txt$</code> - 所有文本文件<br>
                                                <code>.*\.(jpg|png|gif)$</code> - 图片文件<br>
                                            </div>
                                            <div class="col-md-6">
                                                <strong>URL路径匹配：</strong><br>
                                                <code>/download/.*</code> - /download/路径下的文件<br>
                                                <code>files\.example\.com/.*</code> - 特定域名<br>
                                                <code>.*filename\.pdf$</code> - 特定文件名<br>
                                            </div>
                                        </div>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveDownload()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑请求映射模态框 -->
    <div class="modal fade" id="mappingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mappingModalTitle">添加请求映射</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="mappingForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="mappingName" class="form-label">规则名称 *</label>
                                    <input type="text" class="form-control" id="mappingName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="mappingTargetHost" class="form-label">目标主机</label>
                                    <input type="text" class="form-control" id="mappingTargetHost" value="localhost" placeholder="localhost">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="mappingUrlPattern" class="form-label">URL匹配模式 *</label>
                            <input type="text" class="form-control" id="mappingUrlPattern" placeholder="例如: /api/v1/.* 或 https://example.com/.*" required>
                            <div class="form-text">支持正则表达式。例如：<code>/api/v1/.*</code> 匹配所有 /api/v1/ 开头的请求</div>
                        </div>

                        <div class="mb-3">
                            <label for="mappingTargetPort" class="form-label">目标端口 *</label>
                            <input type="number" class="form-control" id="mappingTargetPort" min="1" max="65535" placeholder="3000" required>
                            <div class="form-text">请求将被转发到此端口的本地服务</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">支持的HTTP方法 *</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="methodGET" value="GET" checked>
                                        <label class="form-check-label" for="methodGET">GET</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="methodPOST" value="POST" checked>
                                        <label class="form-check-label" for="methodPOST">POST</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="methodPUT" value="PUT">
                                        <label class="form-check-label" for="methodPUT">PUT</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="methodDELETE" value="DELETE">
                                        <label class="form-check-label" for="methodDELETE">DELETE</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="methodPATCH" value="PATCH">
                                        <label class="form-check-label" for="methodPATCH">PATCH</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="methodHEAD" value="HEAD">
                                        <label class="form-check-label" for="methodHEAD">HEAD</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="methodOPTIONS" value="OPTIONS">
                                        <label class="form-check-label" for="methodOPTIONS">OPTIONS</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">常用映射模式示例</h6>
                                </div>
                                <div class="card-body">
                                    <small class="text-muted">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <strong>API路径映射：</strong><br>
                                                <code>/api/.*</code> - 所有/api/开头的请求<br>
                                                <code>/api/v1/users/.*</code> - 用户相关API<br>
                                                <code>.*\.json$</code> - 所有JSON请求<br>
                                            </div>
                                            <div class="col-md-6">
                                                <strong>域名映射：</strong><br>
                                                <code>api\.example\.com/.*</code> - 特定API域名<br>
                                                <code>.*\.local/.*</code> - 本地域名<br>
                                                <code>localhost:8080/.*</code> - 特定端口<br>
                                            </div>
                                        </div>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveMapping()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast通知 -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <i class="bi bi-info-circle me-2"></i>
                <strong class="me-auto">通知</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody">
                <!-- 通知内容 -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>